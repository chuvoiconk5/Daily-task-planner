<!DOCTYPE html>
<html lang="vi"> <!-- Changed lang to Vietnamese -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng vi·ªác h√†ng ng√†y</title> <!-- Changed title -->
    <!-- Libraries: Defer loading for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js" defer></script> <!-- Added Vietnamese locale for Flatpickr -->
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json"> <!-- Adjusted path -->
    <meta name="theme-color" content="#3b82f6">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #ef4444;
            --accent: #f59e0b;
            --bg-light: #f9fafb;
            --bg-dark: #1f2937;
            --text-light: #111827;
            --text-dark: #f3f4f6;
            --glass-bg: rgba(255, 255, 255, 0.2);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --success: #10b981; /* Added success color */
            /* Added RGB versions for rgba usage */
            --primary-rgb: 59, 130, 246;
            --secondary-rgb: 239, 68, 68;
            --accent-rgb: 245, 158, 11;
            --text-light-rgb: 17, 24, 39;
        }

        [data-theme="dark"] {
            --bg-light: #1f2937;
            --text-light: #f3f4f6;
            --glass-bg: rgba(0, 0, 0, 0.4);
            --glass-border: rgba(255, 255, 255, 0.25);
            --text-light-rgb: 243, 244, 246; /* Update text RGB for dark theme */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #e0f2fe, var(--bg-light));
            color: var(--text-light);
            min-height: 100vh;
            padding: 24px;
            transition: background 0.6s ease, color 0.6s ease;
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scroll on body */
        }

        .container {
            max-width: 1320px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            color: var(--primary);
            text-align: center;
            margin-bottom: 2.2rem;
            letter-spacing: -0.015em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: color 0.6s ease;
        }

        /* --- Date Pickers --- */
        .date-picker {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .date-picker input,
        .history .date-picker-wrapper input { /* Style both similarly initially */
            padding: 0.9rem 1.2rem;
            font-size: 1.05rem;
            border: none;
            border-radius: 14px;
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            width: 260px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease, border 0.3s ease, color 0.3s ease;
        }

        .date-picker input:focus,
        .history .date-picker-wrapper input:focus {
            outline: none;
            transform: scale(1.04);
            box-shadow: 0 0 14px rgba(var(--primary-rgb), 0.5);
        }

        /* --- History Date Picker Specific Style --- */
        .history .date-picker-wrapper {
             margin-bottom: 1.5rem; /* Space below the picker */
             margin-top: 0.5rem; /* Space above the picker */
        }
        .history .date-picker-wrapper input {
             width: 280px; /* Slightly wider for better look */
             font-size: 1rem; /* Slightly smaller font */
             padding: 0.8rem 1.1rem; /* Adjust padding */
             border-radius: 12px; /* Slightly smaller radius */
             /* Add a subtle icon */
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23${props => props.theme === 'dark' ? 'f3f4f6' : '111827'}' width='18px' height='18px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z'/%3E%3C/svg%3E");
             background-repeat: no-repeat;
             background-position: right 1rem center;
             background-size: 18px 18px;
             padding-right: 3rem; /* Make space for the icon */
             transition: all 0.3s ease; /* Ensure all transitions are smooth */
        }
        /* Adjust icon color for dark mode - requires JS or more complex CSS */
        [data-theme="dark"] .history .date-picker-wrapper input {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f3f4f6' width='18px' height='18px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z'/%3E%3C/svg%3E");
        }
         .history .date-picker-wrapper input:focus {
             transform: scale(1.02); /* Less pronounced scale */
             box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.4);
         }


        /* --- Flatpickr Styling --- */
        .flatpickr-calendar {
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            transition: background 0.3s ease, border 0.3s ease;
            z-index: 100; /* Ensure calendar is above other elements */
        }
        .flatpickr-months .flatpickr-month,
        .flatpickr-weekdays,
        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month input.cur-year {
             background: transparent;
             color: var(--text-light);
        }
        .flatpickr-weekday {
             font-size: 90%;
             flex-basis: auto !important; /* Override default flex-basis */
        }
        .flatpickr-day {
            transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
            color: var(--text-light);
            position: relative;
        }
        .flatpickr-day:hover {
             background: rgba(var(--primary-rgb), 0.2);
        }
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange,
        .flatpickr-day.startRange.inRange,
        .flatpickr-day.endRange.inRange,
        .flatpickr-day.selected:focus,
        .flatpickr-day.startRange:focus,
        .flatpickr-day.endRange:focus,
        .flatpickr-day.selected:hover,
        .flatpickr-day.startRange:hover,
        .flatpickr-day.endRange:hover,
        .flatpickr-day.selected.prevMonthDay,
        .flatpickr-day.startRange.prevMonthDay,
        .flatpickr-day.endRange.prevMonthDay,
        .flatpickr-day.selected.nextMonthDay,
        .flatpickr-day.startRange.nextMonthDay,
        .flatpickr-day.endRange.nextMonthDay {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.12);
        }
        .flatpickr-day.today {
            border-color: var(--accent);
            color: var(--accent);
        }
        .flatpickr-day.today:not(.selected) {
             background: transparent;
        }
        .flatpickr-day.today.selected {
             background: var(--primary);
             border-color: var(--primary);
             color: white;
        }
        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            color: rgba(var(--text-light-rgb), 0.4);
            background: transparent;
            cursor: default;
        }
        .flatpickr-day.has-task::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            transition: background 0.6s ease;
        }
        /* --- End Flatpickr Styling --- */

        /* --- Task Form --- */
        .task-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1.2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            padding: 1.8rem;
            border-radius: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
            transition: background 0.3s ease, border 0.3s ease;
        }

        .task-form input, .task-form button {
            padding: 0.9rem;
            font-size: 1rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.3);
            color: var(--text-light);
            transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease, color 0.3s ease;
        }
        [data-theme="dark"] .task-form input,
        [data-theme="dark"] .modal-content input {
             background: rgba(0, 0, 0, 0.2);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }
        [data-theme="dark"] .task-form input:focus,
        [data-theme="dark"] .modal-content input:focus {
             background: rgba(0, 0, 0, 0.3);
        }

        .task-form input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 14px rgba(var(--primary-rgb), 0.5);
            transform: scale(1.03);
        }

        .task-form button {
            background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 80%, black));
            cursor: pointer;
            font-weight: 600;
            color: white;
        }

        .task-form button:hover {
            background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 80%, black), var(--primary));
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(var(--primary-rgb), 0.5);
        }

        /* --- Task Table & History Table --- */
        .table-responsive { /* Add wrapper for scrolling */
             overflow-x: auto;
             -webkit-overflow-scrolling: touch;
             margin-bottom: 2.5rem; /* Keep margin on wrapper */
             /* IMPORTANT: Allow vertical overflow for dropdowns */
             overflow-y: visible;
        }

        .task-table, .history table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            box-shadow: var(--shadow);
            /* REMOVED margin-bottom, now on .table-responsive */
            /* REMOVED overflow: hidden; */
            transition: background 0.3s ease, border 0.3s ease;
        }

        .task-table th, .task-table td, .history table th, .history table td {
            padding: 1.2rem;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.3s ease, color 0.3s ease;
            vertical-align: middle; /* Align content vertically */
            position: relative; /* Needed for absolute positioned children like dropdown */
            /* Ensure TD allows overflow for dropdown */
            overflow: visible;
        }
        .task-table tr:last-child td, .history table tr:last-child td {
             border-bottom: none;
        }

        .task-table th, .history table th {
            background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 80%, black));
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.95rem;
            letter-spacing: 0.06em;
            transition: background 0.6s ease;
            position: sticky; /* Keep headers sticky during horizontal scroll */
            top: 0; /* Required for sticky */
            z-index: 10; /* Ensure headers are above content */
        }
        /* Style first header specifically for rounded corner */
        .task-table thead tr:first-child th:first-child,
        .history thead tr:first-child th:first-child {
            border-top-left-radius: 18px;
        }
        /* Style last header specifically for rounded corner */
        .task-table thead tr:first-child th:last-child,
        .history thead tr:first-child th:last-child {
            border-top-right-radius: 18px;
        }


        .task-table tr, .history table tr {
            transition: background 0.3s ease;
        }

        .task-table tr.draggable {
            cursor: move;
        }
        .task-table tr.sortable-ghost {
            opacity: 0.4;
            background: rgba(var(--primary-rgb), 0.3);
        }

        .task-table tr:hover, .history table tr:hover {
            background: rgba(var(--primary-rgb), 0.1);
        }

        .task-table .task-text, .history table .task-text {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 400;
            word-break: break-word;
            white-space: normal;
        }

        .task-table .completed .task-text, .history table .completed .task-text {
            text-decoration: line-through;
            color: color-mix(in srgb, var(--text-light) 60%, transparent);
            opacity: 0.75;
        }

        /* --- Custom Select Styling (Status Dropdown) --- */
        .custom-select {
            position: relative;
            display: inline-block;
            min-width: 150px;
            vertical-align: middle;
        }

        .custom-select select {
            display: none;
        }

        .select-selected {
            padding: 0.6rem 1rem;
            border-radius: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
            transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease, border 0.3s ease, color 0.3s ease;
            min-width: 100%;
            box-sizing: border-box;
        }
        [data-theme="dark"] .select-selected {
             background: rgba(0, 0, 0, 0.3);
        }

        .select-selected:after {
            content: '‚ñº';
            font-size: 0.7rem;
            margin-left: 0.6rem;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .select-selected:hover {
            background: rgba(var(--primary-rgb), 0.15);
            box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.4);
            transform: scale(1.03);
        }
        [data-theme="dark"] .select-selected:hover {
             background: rgba(var(--primary-rgb), 0.25);
        }

        .select-selected.open:after {
            transform: rotate(180deg);
        }

        .select-items {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            box-shadow: var(--shadow);
            top: calc(100% + 6px); /* Position below the select button */
            left: 0;
            min-width: 100%; /* Ensure dropdown is at least as wide as the button */
            box-sizing: border-box;
            z-index: 99; /* Ensure it's above table rows BUT below sticky header */
            max-height: 200px;
            overflow-y: auto;
            display: none;
            transition: background 0.3s ease, border 0.3s ease;
        }
        [data-theme="dark"] .select-items {
             background: color-mix(in srgb, var(--bg-dark) 90%, white);
        }

        .select-items.show {
            display: block;
        }

        .select-items div {
            /* REDUCED PADDING for less space between items */
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.95rem;
            transition: background 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .select-items div:hover, .select-items div.same-as-selected {
            background: rgba(var(--primary-rgb), 0.15);
        }
        [data-theme="dark"] .select-items div:hover,
        [data-theme="dark"] .select-items div.same-as-selected {
             background: rgba(var(--primary-rgb), 0.25);
        }

        /* Specific styles for dropdowns within the task table */
        .task-table .custom-select {
            min-width: 175px; /* Keep a good minimum width */
        }
        .task-table .select-selected {
             min-width: 170px;
        }
        /* --- End Custom Select Styling --- */


        .task-table button {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            color: white;
            font-weight: 500;
            vertical-align: middle; /* Align buttons nicely */
        }

        .task-table .delete-btn {
            background: linear-gradient(135deg, var(--secondary), color-mix(in srgb, var(--secondary) 80%, black));
            margin-right: 0.6rem;
        }
        .task-table .delete-btn:hover {
             background: linear-gradient(135deg, color-mix(in srgb, var(--secondary) 80%, black), var(--secondary));
        }

        .task-table .edit-btn {
            background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 80%, black));
        }
         .task-table .edit-btn:hover {
             background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 80%, black), var(--accent));
        }

        .task-table .delete-btn:hover, .task-table .edit-btn:hover {
            transform: scale(1.08) translateY(-1px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        }

        /* --- Charts --- */
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.8rem;
            margin-bottom: 2.5rem;
        }

        .chart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            padding: 1.8rem;
            border-radius: 18px;
            box-shadow: var(--shadow);
            transition: background 0.3s ease, border 0.3s ease;
            position: relative;
            min-height: 350px;
        }

        /* --- Insights & History Sections --- */
        .insights, .history {
            background: var(--glass-bg);
            backdrop-filter: blur(14px);
            border: 1px solid var(--glass-border);
            padding: 1.8rem;
            border-radius: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 2.5rem;
            transition: background 0.3s ease, border 0.3s ease, color 0.3s ease;
        }

        .insights h3, .history h3 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary);
            margin-bottom: 1.2rem;
            font-size: 1.4rem;
            transition: color 0.6s ease;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .insights ul {
            list-style: none;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-light);
        }

        .insights ul li {
            margin-bottom: 0.8rem;
            display: flex;
            align-items: flex-start;
        }

        .insights ul li::before {
            content: '‚úì';
            color: var(--accent);
            margin-right: 0.8rem;
            font-size: 1.1rem;
            font-weight: bold;
            transition: color 0.6s ease;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .insights ul li.insight-completed::before {
             color: var(--success);
        }

        .insights .advice {
            font-style: italic;
            color: var(--accent);
            margin-top: 1rem;
            padding-left: 1.8rem;
            position: relative;
        }
        .insights .advice::before {
             content: 'üí°';
             position: absolute;
             left: 0;
             top: 2px;
             font-style: normal;
        }

        /* --- Modal Styling --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .modal.show {
             display: flex;
             opacity: 1;
        }

        .modal-content {
            background: var(--bg-light);
            padding: 2.2rem;
            border-radius: 18px;
            width: 90%;
            max-width: 520px;
            box-shadow: var(--shadow);
            border: 1px solid var(--glass-border);
            transform: scale(0.9);
            opacity: 0;
            transition: background 0.3s ease, border 0.3s ease, transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.4s ease;
        }
        .modal.show .modal-content {
             transform: scale(1);
             opacity: 1;
        }

        .modal-content h2 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.6rem;
            text-align: center;
            transition: color 0.6s ease;
        }

        .modal-content label {
             display: block;
             margin-bottom: 0.5rem;
             font-weight: 600;
             color: var(--text-light);
             font-size: 0.9rem;
        }

        .modal-content input {
            width: 100%;
            padding: 0.9rem;
            margin-bottom: 1.2rem;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.3);
            color: var(--text-light);
            font-size: 1rem;
            transition: box-shadow 0.3s ease, transform 0.3s ease, background 0.3s ease, border 0.3s ease, color 0.3s ease;
        }

        .modal-content input:focus {
            outline: none;
            box-shadow: 0 0 14px rgba(var(--primary-rgb), 0.5);
            transform: scale(1.03);
        }

        .modal-buttons {
             display: flex;
             justify-content: flex-end;
             gap: 0.8rem;
             margin-top: 1.5rem;
        }

        .modal-content button {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .modal-content .save-btn {
            background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--primary) 80%, black));
            color: white;
        }
        .modal-content .save-btn:hover {
             background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 80%, black), var(--primary));
        }

        .modal-content .cancel-btn {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        .modal-content .cancel-btn:hover {
             background: linear-gradient(135deg, #4b5563, #6b7280);
        }

        .modal-content .save-btn:hover, .modal-content .cancel-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        }
        /* --- End Modal Styling --- */

        /* --- Loading Indicator --- */
        .loading {
            display: none;
            text-align: center;
            font-size: 1.1rem;
            color: var(--primary);
            margin: 1.5rem 0;
            font-weight: 500;
            transition: color 0.6s ease;
        }
        .loading.show {
             display: block;
        }

        /* --- Particles Background --- */
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
            transition: opacity 0.6s ease;
        }
        [data-theme="dark"] #particles-js {
             opacity: 0.15;
        }

        /* --- Responsive Design --- */
        @media (max-width: 992px) {
             .task-form {
                 grid-template-columns: 1fr 1fr;
             }
             .task-form input[type="text"] {
                 grid-column: 1 / -1;
             }
             .task-form button {
                 grid-column: 1 / -1;
             }
             .charts {
                 grid-template-columns: 1fr;
             }
        }

        @media (max-width: 768px) {
            body {
                 padding: 16px;
            }
            h1 {
                font-size: 2.2rem;
                margin-bottom: 1.8rem;
            }
            .task-form {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1.5rem;
            }
            .table-responsive {
                 /* Already handles horizontal scroll */
                 margin-bottom: 2.5rem;
            }
            .task-table, .history table {
                /* Table itself doesn't need margin */
                margin-bottom: 0;
                /* Ensure table doesn't shrink below content width */
                min-width: 650px; /* Adjust as needed */
            }
            .task-table th, .task-table td, .history table th, .history table td {
                font-size: 0.9rem;
                padding: 1rem;
                white-space: nowrap; /* Keep nowrap on most cells */
            }
            /* Allow task name to wrap */
            .task-table td:nth-child(1), .history td:nth-child(1) {
                 white-space: normal;
                 min-width: 150px;
            }
            /* Adjust min-widths for other columns if necessary */
            .task-table td:nth-child(4) { min-width: 180px; } /* Status */
            .task-table td:nth-child(5) { min-width: 160px; } /* Actions */

            .date-picker input, .history .date-picker-wrapper input {
                width: 100%; /* Make date pickers full width */
                font-size: 1rem;
            }
            /* History picker icon adjustment on mobile */
            .history .date-picker-wrapper input {
                 padding-right: 3rem; /* Keep space for icon */
                 background-position: right 0.8rem center;
            }

            .charts { gap: 1.5rem; }
            .chart-container, .insights, .history, .modal-content {
                padding: 1.5rem;
                border-radius: 14px;
            }
            .insights h3, .history h3 { font-size: 1.3rem; }
            .insights ul { font-size: 0.95rem; }

            /* Responsive styles for table dropdown */
            .task-table .custom-select {
                min-width: 160px; /* Slightly reduce min-width on mobile */
                width: auto;
            }
             .task-table .select-selected {
                 min-width: 155px;
            }
            .modal-content { width: 95%; }
            .modal-buttons { flex-direction: column-reverse; gap: 0.6rem; }
            .modal-content button { width: 100%; }
        }

        /* --- Dark Mode Body Background --- */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(145deg, #4b5563, var(--bg-dark));
            }
        }
        [data-theme="dark"] body {
             background: linear-gradient(145deg, #4b5563, var(--bg-dark));
        }

    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="container">
        <h1>C√¥ng vi·ªác h√†ng ng√†y</h1> <!-- Changed -->

        <!-- Main Date Picker -->
        <div class="date-picker">
            <input type="text" id="taskDate" aria-label="Ch·ªçn ng√†y xem c√¥ng vi·ªác"> <!-- Changed -->
        </div>

        <!-- Task Input Form -->
        <form class="task-form" onsubmit="addTask(); return false;">
            <input type="text" id="taskInput" placeholder="Nh·∫≠p c√¥ng vi·ªác m·ªõi..." aria-label="T√™n c√¥ng vi·ªác" required> <!-- Changed -->
            <input type="time" id="startTime" aria-label="Th·ªùi gian b·∫Øt ƒë·∫ßu" required> <!-- Changed -->
            <input type="time" id="endTime" aria-label="Th·ªùi gian k·∫øt th√∫c" required> <!-- Changed -->
            <button type="submit">Th√™m c√¥ng vi·ªác</button> <!-- Changed -->
        </form>

        <!-- Loading Indicator -->
        <div class="loading" id="loading" aria-live="assertive">ƒêang t·∫£i c√¥ng vi·ªác...</div> <!-- Changed -->

        <!-- Today's Task Table -->
        <div class="table-responsive">
            <table class="task-table" id="taskTable" aria-live="polite" aria-label="C√¥ng vi·ªác h√¥m nay"> <!-- Changed -->
                <thead>
                    <tr>
                        <th scope="col">T√™n c√¥ng vi·ªác</th> <!-- Changed -->
                        <th scope="col">B·∫Øt ƒë·∫ßu</th> <!-- Changed -->
                        <th scope="col">K·∫øt th√∫c</th> <!-- Changed -->
                        <th scope="col">Tr·∫°ng th√°i</th> <!-- Changed -->
                        <th scope="col">H√†nh ƒë·ªông</th> <!-- Changed -->
                    </tr>
                </thead>
                <tbody id="taskList">
                    <!-- Tasks will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Charts Section -->
        <div class="charts">
            <div class="chart-container">
                <canvas id="dailyChart" aria-label="Bi·ªÉu ƒë·ªì ho√†n th√†nh c√¥ng vi·ªác trong ng√†y"></canvas> <!-- Changed -->
            </div>
            <div class="chart-container">
                <canvas id="historyChart" aria-label="Bi·ªÉu ƒë·ªì t·ª∑ l·ªá ho√†n th√†nh c√¥ng vi·ªác g·∫ßn ƒë√¢y"></canvas> <!-- Changed -->
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights">
            <h3>Nh·∫≠n x√©t trong ng√†y</h3> <!-- Changed -->
            <ul id="dailyComment" aria-live="polite"></ul>
        </div>
        <div class="insights">
             <h3>Nh·∫≠n x√©t tu·∫ßn</h3> <!-- Changed -->
             <ul id="weeklyComment" aria-live="polite"></ul>
        </div>

        <!-- History Section -->
        <div class="history">
            <h3>L·ªãch s·ª≠ c√¥ng vi·ªác</h3> <!-- Changed -->
            <!-- History Date Picker - Moved inside the card -->
            <div class="date-picker-wrapper">
                <input type="text" id="historyDate" aria-label="Ch·ªçn ng√†y xem l·ªãch s·ª≠"> <!-- Changed -->
            </div>
             <div class="table-responsive">
                <table id="historyTable" aria-live="polite" aria-label="L·ªãch s·ª≠ c√¥ng vi·ªác cho ng√†y ƒë√£ ch·ªçn"> <!-- Changed -->
                    <thead>
                        <tr>
                            <th scope="col">T√™n c√¥ng vi·ªác</th> <!-- Changed -->
                            <th scope="col">B·∫Øt ƒë·∫ßu</th> <!-- Changed -->
                            <th scope="col">K·∫øt th√∫c</th> <!-- Changed -->
                            <th scope="col">Tr·∫°ng th√°i</th> <!-- Changed -->
                        </tr>
                    </thead>
                    <tbody id="historyList">
                        <!-- History tasks will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal" id="editModal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" tabindex="-1">
        <div class="modal-content">
            <h2 id="editModalTitle">Ch·ªânh s·ª≠a c√¥ng vi·ªác</h2> <!-- Changed -->
            <input type="hidden" id="editTaskId">
            <div>
                <label for="editTaskInput">T√™n c√¥ng vi·ªác</label> <!-- Changed -->
                <input type="text" id="editTaskInput" aria-label="S·ª≠a t√™n c√¥ng vi·ªác" required> <!-- Changed -->
            </div>
            <div>
                <label for="editStartTime">Th·ªùi gian b·∫Øt ƒë·∫ßu</label> <!-- Changed -->
                <input type="time" id="editStartTime" aria-label="S·ª≠a th·ªùi gian b·∫Øt ƒë·∫ßu" required> <!-- Changed -->
            </div>
            <div>
                <label for="editEndTime">Th·ªùi gian k·∫øt th√∫c</label> <!-- Changed -->
                <input type="time" id="editEndTime" aria-label="S·ª≠a th·ªùi gian k·∫øt th√∫c" required> <!-- Changed -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-btn" onclick="closeModal()">H·ªßy</button> <!-- Changed -->
                <button type="button" class="save-btn" onclick="saveEdit()">L∆∞u thay ƒë·ªïi</button> <!-- Changed -->
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables ---
        let dailyChart = null;
        let historyChart = null;
        let selectedDate = new Date().toISOString().split('T')[0];
        let taskDateInstance = null;
        let historyDateInstance = null;
        let sortableInstance = null;

        const colors = [
            { primary: '#3b82f6', secondary: '#ef4444', accent: '#f59e0b' }, // Blue, Red, Orange
            { primary: '#10b981', secondary: '#f43f5e', accent: '#f97316' }, // Green, Pink, Orange
            { primary: '#8b5cf6', secondary: '#e11d48', accent: '#d97706' }, // Purple, Red, Amber
            { primary: '#ec4899', secondary: '#7c3aed', accent: '#ea580c' }, // Pink, Violet, Orange
            { primary: '#14b8a6', secondary: '#f87171', accent: '#fbbf24' }, // Teal, Red, Amber
            { primary: '#6366f1', secondary: '#fca5a5', accent: '#facc15' }, // Indigo, Red, Yellow
            { primary: '#22c55e', secondary: '#fb7185', accent: '#eab308' }, // Lime, Rose, Yellow
        ];

        // --- Utility Functions ---
        const getTasks = () => {
            try {
                return JSON.parse(localStorage.getItem('tasks')) || [];
            } catch (e) {
                console.error("L·ªói ƒë·ªçc c√¥ng vi·ªác t·ª´ localStorage:", e);
                return []; // Tr·∫£ v·ªÅ m·∫£ng r·ªóng khi c√≥ l·ªói
            }
        };
        const saveTasks = (tasks) => {
            try {
                // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng c√¥ng vi·ªác l∆∞u tr·ªØ ƒë·ªÉ tr√°nh ƒë·∫ßy b·ªô nh·ªõ
                localStorage.setItem('tasks', JSON.stringify(tasks.slice(-1000)));
            } catch (e) {
                console.error("L·ªói l∆∞u c√¥ng vi·ªác v√†o localStorage:", e);
                alert("Kh√¥ng th·ªÉ l∆∞u c√¥ng vi·ªác. B·ªô nh·ªõ c√≥ th·ªÉ ƒë√£ ƒë·∫ßy."); // Th√¥ng b√°o cho ng∆∞·ªùi d√πng
            }
        };
        const getTaskById = (id) => getTasks().find(task => task.id === id);
        const getDayName = (dateStr, locale = 'vi-VN') => { // M·∫∑c ƒë·ªãnh locale ti·∫øng Vi·ªát
            try {
                const date = new Date(`${dateStr}T00:00:00Z`); // S·ª≠ d·ª•ng Z cho UTC ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ m√∫i gi·ªù
                return date.toLocaleDateString(locale, { weekday: 'long' });
            } catch (e) {
                console.error("L·ªói l·∫•y t√™n ng√†y:", e);
                return dateStr; // D·ª± ph√≤ng
            }
        };
        const getTaskDuration = (startTime, endTime) => {
            if (!startTime || !endTime) return 0;
            try {
                const start = new Date(`1970-01-01T${startTime}:00`);
                const end = new Date(`1970-01-01T${endTime}:00`);
                if (isNaN(start) || isNaN(end) || end <= start) return 0;
                return (end - start) / (1000 * 60); // Th·ªùi l∆∞·ª£ng t√≠nh b·∫±ng ph√∫t
            } catch (e) {
                console.error("L·ªói t√≠nh to√°n th·ªùi l∆∞·ª£ng:", e);
                return 0;
            }
        };
        const getCssVariable = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        const formatDate = (dateStr, locale = 'vi-VN') => { // H√†m tr·ª£ gi√∫p ƒë·ªãnh d·∫°ng ng√†y nh·∫•t qu√°n
             try {
                 return new Date(`${dateStr}T00:00:00Z`).toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });
             } catch (e) {
                 console.error("L·ªói ƒë·ªãnh d·∫°ng ng√†y:", e);
                 return dateStr; // D·ª± ph√≤ng
             }
        };
        // Helper to parse color hex to RGB array
        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : null;
        };

        // --- UI Update Functions ---
        const showLoading = () => {
            const loadingEl = document.getElementById('loading');
            if (!loadingEl) return;
            loadingEl.style.display = 'block';
            loadingEl.classList.add('show');
            gsap.fromTo(loadingEl, { opacity: 0 }, { opacity: 1, duration: 0.3 });
        };
        const hideLoading = () => {
            const loadingEl = document.getElementById('loading');
            if (!loadingEl) return;
            gsap.to(loadingEl, {
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                    loadingEl.style.display = 'none';
                    loadingEl.classList.remove('show');
                }
            });
        };

        // --- Color Theme & Particles ---
        function setDayColors() {
            try {
                const day = new Date(`${selectedDate}T00:00:00Z`).getUTCDay(); // S·ª≠ d·ª•ng ng√†y UTC
                const color = colors[day % colors.length];
                const root = document.documentElement;
                root.style.setProperty('--primary', color.primary);
                root.style.setProperty('--secondary', color.secondary);
                root.style.setProperty('--accent', color.accent);

                // Update RGB variables
                const primaryRgb = hexToRgb(color.primary);
                const secondaryRgb = hexToRgb(color.secondary);
                const accentRgb = hexToRgb(color.accent);

                if (primaryRgb) root.style.setProperty('--primary-rgb', primaryRgb.join(', '));
                else console.warn("Kh√¥ng th·ªÉ ph√¢n t√≠ch m√†u ch√≠nh sang RGB:", color.primary);

                if (secondaryRgb) root.style.setProperty('--secondary-rgb', secondaryRgb.join(', '));
                else console.warn("Kh√¥ng th·ªÉ ph√¢n t√≠ch m√†u ph·ª• sang RGB:", color.secondary);

                if (accentRgb) root.style.setProperty('--accent-rgb', accentRgb.join(', '));
                else console.warn("Kh√¥ng th·ªÉ ph√¢n t√≠ch m√†u nh·∫•n sang RGB:", color.accent);

                // Update particles color if particlesJS is initialized
                if (window.pJSDom && window.pJSDom[0] && window.pJSDom[0].pJS) {
                    window.pJSDom[0].pJS.particles.color.value = color.primary;
                    window.pJSDom[0].pJS.fn.particlesRefresh();
                }
            } catch (e) {
                 console.error("L·ªói ƒë·∫∑t m√†u theo ng√†y:", e);
            }
        }

        function initParticles() {
             // ƒê·∫£m b·∫£o particlesJS ƒë√£ ƒë∆∞·ª£c t·∫£i
             if (typeof particlesJS === 'undefined') {
                 console.warn("Particles.js ch∆∞a ƒë∆∞·ª£c t·∫£i. Th·ª≠ l·∫°i sau 500ms.");
                 setTimeout(initParticles, 500); // Th·ª≠ l·∫°i sau m·ªôt kho·∫£ng tr·ªÖ
                 return;
             }
             try {
                 particlesJS("particles-js", {
                     particles: {
                         number: { value: 25, density: { enable: true, value_area: 1000 } },
                         color: { value: getCssVariable('--primary') || '#3b82f6' }, // M√†u d·ª± ph√≤ng
                         shape: { type: "circle" },
                         opacity: { value: 0.4, random: true, anim: { enable: true, speed: 0.5, opacity_min: 0.1, sync: false } },
                         size: { value: 3, random: true, anim: { enable: false } },
                         line_linked: { enable: false },
                         move: { enable: true, speed: 1, direction: "none", random: true, straight: false, out_mode: "out", bounce: false }
                     },
                     interactivity: {
                         detect_on: "canvas",
                         events: { onhover: { enable: true, mode: "bubble" }, onclick: { enable: true, mode: "push" } },
                         modes: { bubble: { distance: 150, size: 5, duration: 2, opacity: 0.8 }, push: { particles_nb: 3 } }
                     },
                     retina_detect: true
                 });
             } catch (e) {
                  console.error("L·ªói kh·ªüi t·∫°o Particles.js:", e);
             }
        }

        function triggerParticleBurst() {
             try {
                 if (window.pJSDom && window.pJSDom[0] && window.pJSDom[0].pJS) {
                     const pJS = window.pJSDom[0].pJS;
                     const currentColor = getCssVariable('--primary') || '#3b82f6';
                     pJS.particles.number.value = 60;
                     pJS.particles.move.speed = 4;
                     pJS.particles.color.value = currentColor;
                     pJS.fn.particlesRefresh();

                     setTimeout(() => {
                         if (window.pJSDom && window.pJSDom[0] && window.pJSDom[0].pJS) {
                             pJS.particles.number.value = 25;
                             pJS.particles.move.speed = 1;
                             pJS.fn.particlesRefresh();
                         }
                     }, 1200);
                 }
             } catch (e) {
                  console.error("L·ªói k√≠ch ho·∫°t hi·ªáu ·ª©ng h·∫°t:", e);
             }
        }

        // --- Dark/Light Mode ---
        const setTheme = () => {
            try {
                const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                const theme = prefersDark ? "dark" : "light";
                document.documentElement.setAttribute("data-theme", theme);
                // C·∫≠p nh·∫≠t bi·∫øn CSS RGB cho text-light d·ª±a tr√™n theme
                const textLightColor = getCssVariable('--text-light');
                const textLightRgb = hexToRgb(textLightColor);
                if(textLightRgb) {
                    document.documentElement.style.setProperty('--text-light-rgb', textLightRgb.join(', '));
                } else {
                    // Fallback if color is not hex (e.g., name or invalid)
                    document.documentElement.style.setProperty('--text-light-rgb', theme === 'dark' ? '243, 244, 246' : '17, 24, 39');
                }

                // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì sau khi thay ƒë·ªïi theme (ƒë·∫£m b·∫£o bi·ªÉu ƒë·ªì t·ªìn t·∫°i)
                if (typeof Chart !== 'undefined') {
                     // Tr√¨ ho√£n m·ªôt ch√∫t ƒë·ªÉ cho ph√©p c√°c bi·∫øn CSS c·∫≠p nh·∫≠t
                     setTimeout(() => {
                         if (dailyChart || historyChart) updateCharts();
                     }, 50);
                }
            } catch (e) {
                 console.error("L·ªói ƒë·∫∑t theme:", e);
            }
        };

        // --- Flatpickr Initialization & Updates ---
        function getTaskDates() {
            const tasks = getTasks();
            // S·ª≠ d·ª•ng Set ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p v√† sau ƒë√≥ s·∫Øp x·∫øp
            return [...new Set(tasks.map(task => task.date))].sort();
        }

        function updateFlatpickrVisuals() {
            try {
                const taskDatesSet = new Set(getTaskDates());

                // C·∫≠p nh·∫≠t ng√†y c√≥ c√¥ng vi·ªác tr√™n c·∫£ hai date picker
                document.querySelectorAll('.flatpickr-day').forEach(dayElem => {
                    const dateStr = dayElem.getAttribute('aria-label') ? flatpickr.formatDate(new Date(dayElem.dateObj), 'Y-m-d') : null;
                    if (dateStr) {
                        if (taskDatesSet.has(dateStr)) {
                            dayElem.classList.add("has-task");
                            dayElem.title = dayElem.getAttribute('aria-label') + " (c√≥ c√¥ng vi·ªác)";
                        } else {
                            dayElem.classList.remove("has-task");
                            // X√≥a title n·∫øu kh√¥ng c√≤n c√¥ng vi·ªác
                            if (dayElem.title?.includes('(c√≥ c√¥ng vi·ªác)')) {
                                dayElem.title = dayElem.getAttribute('aria-label');
                            }
                        }
                    }
                });

                // Kh√¥ng c·∫ßn set 'enable' v√¨ onDayCreate x·ª≠ l√Ω vi·ªác ƒë√°nh d·∫•u ng√†y
                if (taskDateInstance) taskDateInstance.redraw();
                if (historyDateInstance) historyDateInstance.redraw();

            } catch (e) {
                 console.error("L·ªói c·∫≠p nh·∫≠t giao di·ªán Flatpickr:", e);
            }
        }


        function initFlatpickr() {
             // ƒê·∫£m b·∫£o Flatpickr v√† locale ti·∫øng Vi·ªát ƒë√£ ƒë∆∞·ª£c t·∫£i
             if (typeof flatpickr === 'undefined' || typeof flatpickr.l10ns.vn === 'undefined') {
                 console.warn("Flatpickr ho·∫∑c locale ti·∫øng Vi·ªát ch∆∞a ƒë∆∞·ª£c t·∫£i. Th·ª≠ l·∫°i sau 500ms.");
                 setTimeout(initFlatpickr, 500); // Th·ª≠ l·∫°i
                 return;
             }

             try {
                 flatpickr.localize(flatpickr.l10ns.vn); // ƒê·∫∑t locale ti·∫øng Vi·ªát

                 const commonOptions = {
                     dateFormat: "Y-m-d",
                     altInput: true,
                     altFormat: "l, d/m/Y", // ƒê·ªãnh d·∫°ng ti·∫øng Vi·ªát: Th·ª©..., dd/mm/yyyy
                     locale: "vn", // S·ª≠ d·ª•ng locale ti·∫øng Vi·ªát
                     onDayCreate: function(dObj, dStr, fp, dayElem) {
                         // dStr ƒë∆∞·ª£c t·∫°o b·ªüi flatpickr d·ª±a tr√™n dateFormat
                         const taskDatesSet = new Set(getTaskDates());
                         if (taskDatesSet.has(dStr)) {
                             dayElem.classList.add("has-task");
                             // Th√™m tooltip cho kh·∫£ nƒÉng truy c·∫≠p
                             dayElem.title = dayElem.getAttribute('aria-label') + " (c√≥ c√¥ng vi·ªác)";
                         }
                     },
                     // Th√™m onMonthChange v√† onYearChange ƒë·ªÉ v·∫Ω l·∫°i c√°c d·∫•u ch·∫•m
                     onMonthChange: function(selectedDates, dateStr, instance) {
                         instance.redraw();
                     },
                     onYearChange: function(selectedDates, dateStr, instance) {
                         instance.redraw();
                     }
                 };

                 taskDateInstance = flatpickr("#taskDate", {
                     ...commonOptions,
                     defaultDate: selectedDate,
                     // Kh√¥ng c·∫ßn 'enable' ·ªü ƒë√¢y n·ªØa v√¨ onDayCreate x·ª≠ l√Ω visual
                     onChange: (selectedDates, dateStr) => {
                         if (!dateStr) return;
                         selectedDate = dateStr;
                         setDayColors();
                         gsap.to("#taskList", {
                             opacity: 0,
                             y: -20,
                             duration: 0.3,
                             ease: "power2.in",
                             onComplete: () => {
                                 loadTasks();
                                 gsap.fromTo("#taskList", { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.4, ease: "power2.out", delay: 0.1 });
                             }
                         });
                         updateCharts();
                     },
                 });

                 historyDateInstance = flatpickr("#historyDate", {
                     ...commonOptions,
                     // Kh√¥ng c·∫ßn 'enable' ·ªü ƒë√¢y n·ªØa
                     onChange: (selectedDates, dateStr) => {
                         const historyListBody = document.getElementById('historyList');
                         if (!historyListBody) return;

                         // X√≥a danh s√°ch l·ªãch s·ª≠ ngay l·∫≠p t·ª©c tr∆∞·ªõc khi t·∫£i
                         historyListBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; font-style: italic;">ƒêang t·∫£i l·ªãch s·ª≠...</td></tr>`;
                         if (!dateStr) {
                             historyListBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; font-style: italic;">Ch·ªçn m·ªôt ng√†y ƒë·ªÉ xem l·ªãch s·ª≠.</td></tr>`;
                             return;
                         }
                         // T·∫£i l·ªãch s·ª≠ sau m·ªôt kho·∫£ng tr·ªÖ nh·ªè ƒë·ªÉ cho ph√©p UI c·∫≠p nh·∫≠t
                         setTimeout(() => loadHistory(dateStr), 50);
                     }
                 });
             } catch (e) {
                  console.error("L·ªói kh·ªüi t·∫°o Flatpickr:", e);
             }
        }

        // --- Custom Select Initialization ---
        function initCustomSelect(selectId) {
            try {
                const selElmnt = document.getElementById(selectId);
                if (!selElmnt) {
                    // console.warn(`Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ select: ${selectId}`);
                    return;
                }

                const selContainer = selElmnt.closest('.custom-select');
                if (!selContainer) {
                     console.error(`Kh√¥ng t√¨m th·∫•y container custom select cho: ${selectId}`);
                     return;
                }
                // NgƒÉn ch·∫∑n kh·ªüi t·∫°o l·∫°i n·∫øu ƒë√£ c√≥
                if (selContainer.querySelector('.select-selected')) return;

                selContainer.dataset.originalSelectId = selectId;
                selElmnt.style.display = 'none'; // ·∫®n select g·ªëc

                const selSelected = document.createElement("DIV");
                selSelected.setAttribute("class", "select-selected");
                selSelected.setAttribute("aria-haspopup", "listbox");
                selSelected.setAttribute("aria-expanded", "false");
                selSelected.setAttribute("tabindex", "0"); // Cho ph√©p focus
                // L·∫•y text c·ªßa option ƒëang ƒë∆∞·ª£c ch·ªçn trong select g·ªëc
                const selectedOptionText = selElmnt.options[selElmnt.selectedIndex] ? selElmnt.options[selElmnt.selectedIndex].innerHTML : '';
                selSelected.innerHTML = `<span>${selectedOptionText}</span>`; // Hi·ªÉn th·ªã text ƒë√£ d·ªãch
                selContainer.appendChild(selSelected);

                const selItems = document.createElement("DIV");
                selItems.setAttribute("class", "select-items");
                selItems.setAttribute("role", "listbox"); // Vai tr√≤ cho accessibility

                for (let i = 0; i < selElmnt.options.length; i++) {
                    const item = document.createElement("DIV");
                    item.innerHTML = selElmnt.options[i].innerHTML; // L·∫•y text ƒë√£ d·ªãch t·ª´ option g·ªëc
                    item.setAttribute("role", "option");
                    item.setAttribute("tabindex", "-1"); // Cho ph√©p focus khi ƒëi·ªÅu h∆∞·ªõng b·∫±ng ph√≠m
                    item.dataset.value = selElmnt.options[i].value; // L∆∞u gi√° tr·ªã g·ªëc

                    if (i === selElmnt.selectedIndex) {
                        item.classList.add("same-as-selected");
                        item.setAttribute("aria-selected", "true");
                    } else {
                        item.setAttribute("aria-selected", "false");
                    }

                    item.addEventListener("click", function(e) {
                        const s = selElmnt; // Select g·ªëc
                        const currentSelectedText = selSelected.querySelector('span');
                        if (!s || !currentSelectedText) return;

                        // C·∫≠p nh·∫≠t gi√° tr·ªã select g·ªëc *tr∆∞·ªõc* khi k√≠ch ho·∫°t s·ª± ki·ªán change
                        s.value = this.dataset.value;

                        // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã
                        currentSelectedText.innerHTML = this.innerHTML;

                        // C·∫≠p nh·∫≠t class v√† thu·ªôc t√≠nh aria
                        const siblings = this.parentNode.children;
                        for (let sib of siblings) {
                            sib.classList.remove("same-as-selected");
                            sib.setAttribute("aria-selected", "false");
                        }
                        this.classList.add("same-as-selected");
                        this.setAttribute("aria-selected", "true");

                        // ƒê√≥ng dropdown
                        closeDropdown(selContainer);
                        selSelected.focus(); // ƒê∆∞a focus v·ªÅ n√∫t ch·ªçn

                        // K√≠ch ho·∫°t s·ª± ki·ªán change *sau* khi c·∫≠p nh·∫≠t gi√° tr·ªã v√† UI
                        s.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                    selItems.appendChild(item);
                }
                selContainer.appendChild(selItems);

                // S·ª± ki·ªán click ƒë·ªÉ m·ªü/ƒë√≥ng dropdown
                selSelected.addEventListener("click", function(e) {
                    e.stopPropagation(); // NgƒÉn s·ª± ki·ªán lan ra document
                    toggleDropdown(selContainer);
                });

                // S·ª± ki·ªán ph√≠m cho n√∫t ch·ªçn
                selSelected.addEventListener("keydown", function(e) {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        toggleDropdown(selContainer);
                    } else if (e.key === "Escape") {
                        closeDropdown(selContainer);
                    } else if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                         // M·ªü dropdown v√† focus v√†o option ƒë·∫ßu ti√™n/cu·ªëi c√πng n·∫øu ƒë√≥ng
                         if (!selItems.classList.contains('show')) {
                             toggleDropdown(selContainer);
                         }
                         // ƒêi·ªÅu h∆∞·ªõng trong c√°c options (h√†m navigateOptions x·ª≠ l√Ω)
                         navigateOptions(selItems, e.key);
                         e.preventDefault();
                    }
                });

                // S·ª± ki·ªán ph√≠m cho c√°c m·ª•c trong dropdown
                selItems.addEventListener("keydown", function(e) {
                    if (e.key === "Escape") {
                        closeDropdown(selContainer);
                        selSelected.focus(); // Tr·∫£ focus v·ªÅ n√∫t
                    } else if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        // Click v√†o m·ª•c ƒëang ƒë∆∞·ª£c focus
                        if (document.activeElement && document.activeElement.getAttribute('role') === 'option') {
                            document.activeElement.click();
                        }
                    } else if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                        e.preventDefault();
                        navigateOptions(selItems, e.key); // ƒêi·ªÅu h∆∞·ªõng l√™n/xu·ªëng
                    }
                });
            } catch (e) {
                 console.error(`L·ªói kh·ªüi t·∫°o custom select ${selectId}:`, e);
            }
        }

        function toggleDropdown(container) {
            if (!container) return;
            const items = container.querySelector('.select-items');
            const button = container.querySelector('.select-selected');
            if (!items || !button) return;
            const isOpen = items.classList.contains('show');
            closeAllDropdowns(); // ƒê√≥ng t·∫•t c·∫£ c√°c dropdown kh√°c tr∆∞·ªõc
            if (!isOpen) {
                items.classList.add('show');
                button.classList.add('open');
                button.setAttribute('aria-expanded', 'true');
                // Focus v√†o m·ª•c ƒë√£ ch·ªçn ho·∫∑c m·ª•c ƒë·∫ßu ti√™n khi m·ªü
                const selectedOption = items.querySelector('.same-as-selected') || items.firstElementChild;
                if (selectedOption) selectedOption.focus();
            }
        }

        function closeDropdown(container) {
            if (!container) return;
            const items = container.querySelector('.select-items');
            const button = container.querySelector('.select-selected');
            if (!items || !button) return;
            items.classList.remove('show');
            button.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
        }

        function closeAllDropdowns(exceptThisOne = null) {
            document.querySelectorAll('.custom-select .select-items.show').forEach(openDropdown => {
                const container = openDropdown.closest('.custom-select');
                // Ch·ªâ ƒë√≥ng n·∫øu kh√¥ng ph·∫£i l√† dropdown ƒëang ƒë∆∞·ª£c t∆∞∆°ng t√°c
                if (container !== exceptThisOne) {
                    closeDropdown(container);
                }
            });
        }

        function navigateOptions(itemsContainer, direction) {
             if (!itemsContainer) return;
             const options = Array.from(itemsContainer.children).filter(el => el.getAttribute('role') === 'option'); // Ch·ªâ l·∫•y c√°c option
             if (options.length === 0) return;

             let currentFocusIndex = options.findIndex(opt => opt === document.activeElement);

             if (direction === "ArrowDown") {
                 currentFocusIndex = (currentFocusIndex + 1) % options.length;
             } else if (direction === "ArrowUp") {
                 currentFocusIndex = (currentFocusIndex - 1 + options.length) % options.length;
             } else {
                 // N·∫øu kh√¥ng c√≥ m·ª•c n√†o ƒëang focus, focus v√†o m·ª•c ƒë·∫ßu ti√™n khi nh·∫•n ArrowDown
                 if (currentFocusIndex === -1 && direction === "ArrowDown") {
                     currentFocusIndex = 0;
                 }
                 // Focus v√†o m·ª•c cu·ªëi c√πng khi nh·∫•n ArrowUp
                 else if (currentFocusIndex === -1 && direction === "ArrowUp") {
                      currentFocusIndex = options.length - 1;
                 }
             }

             if (currentFocusIndex >= 0 && currentFocusIndex < options.length) {
                 options[currentFocusIndex].focus(); // S·ª≠ d·ª•ng optional chaining ph√≤ng tr∆∞·ªùng h·ª£p l·ªói
             }
        }

        // ƒê√≥ng dropdown khi click ra ngo√†i
        document.addEventListener("click", function(e) {
            // Ki·ªÉm tra xem click c√≥ n·∫±m trong b·∫•t k·ª≥ custom-select n√†o kh√¥ng
            if (!e.target.closest('.custom-select')) {
                closeAllDropdowns();
            }
        });

        // MutationObserver ƒë·ªÉ kh·ªüi t·∫°o select ƒë∆∞·ª£c th√™m ƒë·ªông (v√≠ d·ª• khi th√™m task m·ªõi)
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        // Ch·ªâ x·ª≠ l√Ω Element nodes
                        if (node.nodeType === 1) {
                             // T√¨m select b√™n trong node ƒë∆∞·ª£c th√™m ho·∫∑c ch√≠nh node ƒë√≥
                             const selects = node.matches('select[id^="status_"]') ? [node] : node.querySelectorAll('select[id^="status_"]');
                             selects.forEach(sel => {
                                 const container = sel.closest('.custom-select');
                                 // Kh·ªüi t·∫°o ch·ªâ khi UI t√πy ch·ªânh ch∆∞a ƒë∆∞·ª£c x√¢y d·ª±ng
                                 if (sel.id && container && !container.querySelector('.select-selected')) {
                                     // S·ª≠ d·ª•ng requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n khi kh·ªüi t·∫°o
                                     requestAnimationFrame(() => initCustomSelect(sel.id));
                                 }
                             });
                        }
                    });
                }
            }
        });
        // Quan s√°t body c·ªßa danh s√°ch c√¥ng vi·ªác ƒë·ªÉ ph√°t hi·ªán thay ƒë·ªïi
        const taskListElement = document.getElementById('taskList');
        if (taskListElement) {
            observer.observe(taskListElement, { childList: true, subtree: true });
        } else {
             console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ danh s√°ch c√¥ng vi·ªác (#taskList) cho MutationObserver.");
        }


        // --- PWA Service Worker ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi, gi·∫£ s·ª≠ sw.js c√πng th∆∞ m·ª•c
                navigator.serviceWorker.register('sw.js') // ƒê·∫£m b·∫£o t√™n file l√† sw.js
                    .then(registration => {
                        console.log('Service Worker ƒë√£ ƒëƒÉng k√Ω v·ªõi scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('ƒêƒÉng k√Ω Service Worker th·∫•t b·∫°i:', err);
                    });
            } else {
                 console.log('Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ Service Worker.');
            }
        }

        // --- Task Management Functions ---
        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');

            // Ki·ªÉm tra ph·∫ßn t·ª≠ t·ªìn t·∫°i tr∆∞·ªõc khi truy c·∫≠p value
            if (!taskInput || !startTimeInput || !endTimeInput) {
                console.error("M·ªôt ho·∫∑c nhi·ªÅu tr∆∞·ªùng input kh√¥ng t√¨m th·∫•y.");
                alert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i.');
                return;
            }

            const taskText = taskInput.value.trim();
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            if (!taskText || !startTime || !endTime) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin c√¥ng vi·ªác (T√™n, B·∫Øt ƒë·∫ßu, K·∫øt th√∫c).');
                return;
            }

            try {
                if (new Date(`1970-01-01T${endTime}:00`) <= new Date(`1970-01-01T${startTime}:00`)) {
                    alert('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu.');
                    endTimeInput.focus();
                    return;
                }
            } catch (e) {
                 alert('ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá.');
                 console.error("ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá:", e);
                 return;
            }

            const allTasks = getTasks();
            const tasksForDate = allTasks.filter(t => t.date === selectedDate);

            const newTask = {
                id: Date.now(),
                text: taskText,
                date: selectedDate,
                startTime,
                endTime,
                status: 'Incomplete', // Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh: Ch∆∞a ho√†n th√†nh
                order: tasksForDate.length // ƒê·∫∑t th·ª© t·ª± ban ƒë·∫ßu d·ª±a tr√™n s·ªë l∆∞·ª£ng task hi·ªán c√≥ trong ng√†y
            };

            allTasks.push(newTask);
            saveTasks(allTasks);

            // Ch·ªâ render l·∫°i n·∫øu task m·ªõi thu·ªôc ng√†y ƒëang ch·ªçn
            if (newTask.date === selectedDate) {
                // X√≥a th√¥ng b√°o "Kh√¥ng c√≥ c√¥ng vi·ªác" n·∫øu c√≥
                const noTaskRow = document.querySelector('#taskList .no-tasks-row');
                if (noTaskRow) noTaskRow.remove();
                renderTask(newTask); // Render task m·ªõi v√†o cu·ªëi danh s√°ch
            }

            resetForm();
            updateCharts();
            updateFlatpickrVisuals(); // C·∫≠p nh·∫≠t d·∫•u ch·∫•m tr√™n l·ªãch
            triggerParticleBurst(); // Hi·ªáu ·ª©ng h·∫°t
            taskInput.focus(); // Focus l·∫°i v√†o input t√™n c√¥ng vi·ªác
        }

        function renderTask(task, listId = 'taskList') {
            const taskListBody = document.getElementById(listId);
            if (!taskListBody) {
                console.error(`Kh√¥ng t√¨m th·∫•y tbody v·ªõi ID: ${listId}`);
                return;
            }

            const taskRow = document.createElement('tr');
            taskRow.dataset.id = task.id;
            taskRow.className = task.status === 'Completed' ? 'completed' : '';
            if (listId === 'taskList') {
                 taskRow.classList.add('draggable'); // Ch·ªâ th√™m class draggable cho danh s√°ch ch√≠nh
            }
            // D·ªãch tr·∫°ng th√°i cho aria-label
            const statusTextAria = task.status === 'Completed' ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
            taskRow.setAttribute('aria-label', `C√¥ng vi·ªác: ${task.text}, Tr·∫°ng th√°i: ${statusTextAria}`);

            const isMainList = listId === 'taskList';
            // D·ªãch tr·∫°ng th√°i cho hi·ªÉn th·ªã v√† options
            const incompleteText = "Ch∆∞a ho√†n th√†nh";
            const completedText = "ƒê√£ ho√†n th√†nh";
            const statusDisplayText = task.status === 'Completed' ? completedText : incompleteText;

            taskRow.innerHTML = `
                <td><span class="task-text">${task.text}</span></td>
                <td>${task.startTime || 'N/A'}</td>
                <td>${task.endTime || 'N/A'}</td>
                <td>
                    ${isMainList ? `
                        <div class="custom-select status-select">
                            <select id="status_${task.id}" data-task-id="${task.id}" onchange="updateTaskStatus(event)" aria-label="C·∫≠p nh·∫≠t tr·∫°ng th√°i cho ${task.text}">
                                <option value="Incomplete" ${task.status === 'Incomplete' ? 'selected' : ''}>${incompleteText}</option>
                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>${completedText}</option>
                            </select>
                        </div>
                    ` : statusDisplayText /* Hi·ªÉn th·ªã text tr·∫°ng th√°i ƒë√£ d·ªãch cho l·ªãch s·ª≠ */}
                </td>
                ${isMainList ? `
                    <td class="actions">
                        <button type="button" class="edit-btn" onclick="openEditModal(${task.id})" aria-label="S·ª≠a c√¥ng vi·ªác ${task.text}">S·ª≠a</button>
                        <button type="button" class="delete-btn" onclick="deleteTask(${task.id})" aria-label="X√≥a c√¥ng vi·ªác ${task.text}">X√≥a</button>
                    </td>
                ` : ''}
            `;

            taskListBody.appendChild(taskRow);

            // Animation cho h√†ng m·ªõi th√™m (ch·ªâ khi l√† danh s√°ch ch√≠nh)
            if (isMainList) {
                gsap.from(taskRow, {
                    opacity: 0,
                    x: -50, // Hi·ªáu ·ª©ng tr∆∞·ª£t t·ª´ tr√°i sang
                    duration: 0.5,
                    ease: "power3.out",
                    // Delay nh·∫π d·ª±a tr√™n v·ªã tr√≠ ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng x·∫øp t·∫ßng
                    delay: (taskListBody.children.length -1) * 0.03
                });
            }


            // Kh·ªüi t·∫°o custom select ch·ªâ cho danh s√°ch ch√≠nh
            // MutationObserver s·∫Ω x·ª≠ l√Ω vi·ªác n√†y, nh∆∞ng g·ªçi l·∫°i ·ªü ƒë√¢y ƒë·ªÉ ƒë·∫£m b·∫£o
            if (isMainList) {
                 const selectId = `status_${task.id}`;
                 // D√πng requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o ph·∫ßn t·ª≠ ƒë√£ ho√†n to√†n trong DOM
                 requestAnimationFrame(() => initCustomSelect(selectId));
            }
        }

        function loadTasks() {
            showLoading();
            const taskListBody = document.getElementById('taskList');
            if (!taskListBody) {
                 console.error("Kh√¥ng t√¨m th·∫•y tbody #taskList.");
                 hideLoading();
                 return;
            }
            taskListBody.innerHTML = ''; // X√≥a n·ªôi dung c≈©

            const tasksForSelectedDate = getTasks()
                .filter(task => task.date === selectedDate)
                // S·∫Øp x·∫øp theo thu·ªôc t√≠nh 'order', n·∫øu kh√¥ng c√≥ th√¨ d√πng 'id'
                .sort((a, b) => (a.order ?? a.id) - (b.order ?? b.id));

            if (tasksForSelectedDate.length === 0) {
                 // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ c√¥ng vi·ªác
                 taskListBody.innerHTML = `<tr class="no-tasks-row"><td colspan="5" style="text-align:center; padding: 2rem; font-style: italic;">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c l√™n l·ªãch cho ng√†y ${formatDate(selectedDate)}.</td></tr>`;
            } else {
                tasksForSelectedDate.forEach(task => renderTask(task));
            }

            initSortable(); // Kh·ªüi t·∫°o ho·∫∑c kh·ªüi t·∫°o l·∫°i SortableJS
            hideLoading();
        }

        function updateTaskStatus(event) {
             const selectElement = event.target;
             // L·∫•y taskId t·ª´ data attribute c·ªßa select g·ªëc
             const taskId = parseInt(selectElement.dataset.taskId);
             const newStatus = selectElement.value;

             if (isNaN(taskId)) {
                 console.error("ID c√¥ng vi·ªác kh√¥ng h·ª£p l·ªá trong updateTaskStatus:", selectElement.dataset.taskId);
                 return;
             }

             let tasks = getTasks();
             let taskUpdated = false;
             let updatedTaskText = ''; // ƒê·ªÉ c·∫≠p nh·∫≠t aria-label

             tasks = tasks.map(task => {
                 if (task.id === taskId) {
                     if (task.status !== newStatus) { // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu tr·∫°ng th√°i th·ª±c s·ª± thay ƒë·ªïi
                         taskUpdated = true;
                         updatedTaskText = task.text; // L∆∞u text tr∆∞·ªõc khi c·∫≠p nh·∫≠t
                         return { ...task, status: newStatus };
                     }
                 }
                 return task;
             });

             if (taskUpdated) {
                 saveTasks(tasks);
                 const taskRow = document.querySelector(`#taskList tr[data-id="${taskId}"]`);
                 if (taskRow) {
                     // C·∫≠p nh·∫≠t class 'completed'
                     taskRow.classList.toggle('completed', newStatus === 'Completed');
                     // C·∫≠p nh·∫≠t aria-label v·ªõi tr·∫°ng th√°i ƒë√£ d·ªãch
                     const statusTextAria = newStatus === 'Completed' ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
                     taskRow.setAttribute('aria-label', `C√¥ng vi·ªác: ${updatedTaskText}, Tr·∫°ng th√°i: ${statusTextAria}`);

                     // Ph·∫£n h·ªìi tr·ª±c quan (nh·∫•p nh√°y nh·∫π)
                     gsap.fromTo(taskRow,
                        { backgroundColor: 'rgba(var(--primary-rgb), 0.2)' },
                        { backgroundColor: 'transparent', duration: 0.8, ease: 'none' });
                 } else {
                      console.warn(`Kh√¥ng t√¨m th·∫•y h√†ng c√¥ng vi·ªác v·ªõi ID ${taskId} ƒë·ªÉ c·∫≠p nh·∫≠t UI.`);
                 }
                 updateCharts(); // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì sau khi thay ƒë·ªïi tr·∫°ng th√°i
             }
        }

        function deleteTask(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?')) {
                return;
            }

            const taskRow = document.querySelector(`#taskList tr[data-id="${id}"]`);
            if (taskRow) {
                // Animation x√≥a h√†ng
                gsap.to(taskRow, {
                    opacity: 0,
                    x: 100, // Tr∆∞·ª£t sang ph·∫£i
                    height: 0,
                    paddingTop: 0,
                    paddingBottom: 0,
                    marginTop: 0,
                    marginBottom: 0,
                    duration: 0.4,
                    ease: "power2.in",
                    onComplete: () => {
                        let tasks = getTasks();
                        tasks = tasks.filter(task => task.id !== id);
                        saveTasks(tasks);

                        taskRow.remove(); // X√≥a ph·∫ßn t·ª≠ kh·ªèi DOM

                        // Ki·ªÉm tra xem danh s√°ch c√≥ r·ªóng kh√¥ng sau khi x√≥a
                        const taskListBody = document.getElementById('taskList');
                        if (taskListBody && taskListBody.children.length === 0) {
                             taskListBody.innerHTML = `<tr class="no-tasks-row"><td colspan="5" style="text-align:center; padding: 2rem; font-style: italic;">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c l√™n l·ªãch cho ng√†y ${formatDate(selectedDate)}.</td></tr>`;
                        }

                        updateCharts();
                        updateFlatpickrVisuals(); // C·∫≠p nh·∫≠t l·ªãch (c√≥ th·ªÉ ng√†y ƒë√≥ h·∫øt task)
                    }
                });
            } else {
                 // D·ª± ph√≤ng n·∫øu kh√¥ng t√¨m th·∫•y h√†ng (√≠t x·∫£y ra)
                 console.warn("Kh√¥ng t√¨m th·∫•y h√†ng c√¥ng vi·ªác ƒë·ªÉ x√≥a:", id);
                 let tasks = getTasks();
                 tasks = tasks.filter(task => task.id !== id);
                 saveTasks(tasks);
                 loadTasks(); // T·∫£i l·∫°i danh s√°ch l√†m d·ª± ph√≤ng
                 updateCharts();
                 updateFlatpickrVisuals();
            }
        }

        // --- Edit Modal Functions ---
        let focusTrapListener = null; // Bi·∫øn l∆∞u tr·ªØ listener b·∫´y focus

        function openEditModal(id) {
            const task = getTaskById(id);
            if (!task) {
                console.error("Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác ƒë·ªÉ s·ª≠a:", id);
                alert("Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác!");
                return;
            }

            // ƒêi·ªÅn d·ªØ li·ªáu v√†o modal
            const taskIdInput = document.getElementById('editTaskId');
            const taskInput = document.getElementById('editTaskInput');
            const startTimeInput = document.getElementById('editStartTime');
            const endTimeInput = document.getElementById('editEndTime');
            const modal = document.getElementById('editModal');

            if (!taskIdInput || !taskInput || !startTimeInput || !endTimeInput || !modal) {
                console.error("M·ªôt ho·∫∑c nhi·ªÅu ph·∫ßn t·ª≠ modal kh√¥ng t√¨m th·∫•y.");
                alert("L·ªói giao di·ªán ch·ªânh s·ª≠a. Vui l√≤ng th·ª≠ l·∫°i.");
                return;
            }

            taskIdInput.value = task.id;
            taskInput.value = task.text;
            startTimeInput.value = task.startTime;
            endTimeInput.value = task.endTime;

            modal.classList.add('show');
            taskInput.focus(); // Focus v√†o tr∆∞·ªùng t√™n c√¥ng vi·ªác
            addFocusTrap(modal); // Th√™m b·∫´y focus
        }

        function saveEdit() {
            const idInput = document.getElementById('editTaskId');
            const textInput = document.getElementById('editTaskInput');
            const startTimeInput = document.getElementById('editStartTime');
            const endTimeInput = document.getElementById('editEndTime');

            if (!idInput || !textInput || !startTimeInput || !endTimeInput) {
                 console.error("Thi·∫øu tr∆∞·ªùng input trong modal khi l∆∞u.");
                 closeModal();
                 return;
            }

            const id = parseInt(idInput.value);
            const text = textInput.value.trim();
            const startTime = startTimeInput.value;
            const endTime = endTimeInput.value;

            if (isNaN(id)) {
                 console.error("ID c√¥ng vi·ªác kh√¥ng h·ª£p l·ªá khi l∆∞u ch·ªânh s·ª≠a.");
                 closeModal();
                 return;
            }

            if (!text || !startTime || !endTime) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng.');
                return;
            }
            try {
                if (new Date(`1970-01-01T${endTime}:00`) <= new Date(`1970-01-01T${startTime}:00`)) {
                    alert('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu.');
                    endTimeInput.focus();
                    return;
                }
            } catch (e) {
                 alert('ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá.');
                 console.error("L·ªói ƒë·ªãnh d·∫°ng th·ªùi gian khi s·ª≠a:", e);
                 return;
            }

            let tasks = getTasks();
            let taskUpdated = false;
            let originalTask = null; // L∆∞u tr·ªØ task g·ªëc ƒë·ªÉ c·∫≠p nh·∫≠t UI

            tasks = tasks.map(task => {
                if (task.id === id) {
                    originalTask = {...task}; // Sao ch√©p task g·ªëc
                    // Ch·ªâ c·∫≠p nh·∫≠t text v√† th·ªùi gian, gi·ªØ nguy√™n status, date, order
                    if (task.text !== text || task.startTime !== startTime || task.endTime !== endTime) {
                        taskUpdated = true;
                        return { ...task, text, startTime, endTime };
                    }
                }
                return task;
            });

            if (taskUpdated && originalTask) {
                saveTasks(tasks);
                closeModal();

                const taskRow = document.querySelector(`#taskList tr[data-id="${id}"]`);
                // Ch·ªâ c·∫≠p nh·∫≠t h√†ng n·∫øu n√≥ ƒëang hi·ªÉn th·ªã (ng√†y c·ªßa task tr√πng v·ªõi ng√†y ƒëang ch·ªçn)
                if (taskRow && originalTask.date === selectedDate) {
                     taskRow.querySelector('.task-text').textContent = text;
                     taskRow.cells[1].textContent = startTime;
                     taskRow.cells[2].textContent = endTime;
                     // C·∫≠p nh·∫≠t aria-label
                     const statusTextAria = originalTask.status === 'Completed' ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
                     taskRow.setAttribute('aria-label', `C√¥ng vi·ªác: ${text}, Tr·∫°ng th√°i: ${statusTextAria}`);
                     // Hi·ªáu ·ª©ng nh·∫•p nh√°y nh·∫π m√†u nh·∫•n
                     gsap.fromTo(taskRow, { backgroundColor: 'rgba(var(--accent-rgb), 0.3)' }, { backgroundColor: 'transparent', duration: 0.8 });
                } else if (originalTask.date === selectedDate) {
                     // N·∫øu ng√†y tr√πng kh·ªõp nh∆∞ng kh√¥ng t√¨m th·∫•y h√†ng (√≠t x·∫£y ra), t·∫£i l·∫°i danh s√°ch
                     console.warn("H√†ng c√¥ng vi·ªác kh√¥ng t√¨m th·∫•y ƒë·ªÉ c·∫≠p nh·∫≠t UI, t·∫£i l·∫°i danh s√°ch.");
                     loadTasks();
                }
                // Kh√¥ng c·∫ßn c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì n·∫øu ch·ªâ thay ƒë·ªïi text/th·ªùi gian
                // updateCharts();
            } else if (!taskUpdated) {
                 console.log("Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c th·ª±c hi·ªán.");
                 closeModal(); // ƒê√≥ng modal ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi
            } else {
                 console.warn("Kh√¥ng t√¨m th·∫•y ID c√¥ng vi·ªác khi l∆∞u:", id);
                 closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('editModal');
            if (!modal) return;
            removeFocusTrap(modal); // G·ª° b·ªè b·∫´y focus
            modal.classList.remove('show');
            // Reset form trong modal (t√πy ch·ªçn, nh∆∞ng n√™n l√†m)
            // document.getElementById('editTaskInput').value = '';
            // document.getElementById('editStartTime').value = '';
            // document.getElementById('editEndTime').value = '';
            // document.getElementById('editTaskId').value = '';
        }

        // ƒê√≥ng modal khi click ra ngo√†i v√πng n·ªôi dung
        document.getElementById('editModal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) { // Ch·ªâ ƒë√≥ng khi click v√†o n·ªÅn m·ªù
                closeModal();
            }
        });
        // ƒê√≥ng modal khi nh·∫•n ph√≠m Escape
        document.addEventListener('keydown', (e) => {
             if (e.key === 'Escape' && document.getElementById('editModal')?.classList.contains('show')) {
                 closeModal();
             }
        });

        // --- Focus Trap for Modal ---
        function addFocusTrap(modalElement) {
            if (!modalElement) return;
            // T√¨m t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ th·ªÉ focus b√™n trong modal
            const focusableElements = modalElement.querySelectorAll(
                'button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            if (focusableElements.length === 0) return; // Kh√¥ng c√≥ g√¨ ƒë·ªÉ b·∫´y

            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            // X√≥a listener c≈© n·∫øu c√≥
            removeFocusTrap(modalElement);

            focusTrapListener = (e) => {
                if (e.key !== 'Tab') return; // Ch·ªâ x·ª≠ l√Ω ph√≠m Tab

                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstFocusable) {
                        lastFocusable.focus(); // Quay l·∫°i ph·∫ßn t·ª≠ cu·ªëi
                        e.preventDefault();
                    }
                } else { // Tab
                    if (document.activeElement === lastFocusable) {
                        firstFocusable.focus(); // Quay l·∫°i ph·∫ßn t·ª≠ ƒë·∫ßu
                        e.preventDefault();
                    }
                }
            };
            modalElement.addEventListener('keydown', focusTrapListener);
        }

        function removeFocusTrap(modalElement) {
            if (focusTrapListener && modalElement) {
                modalElement.removeEventListener('keydown', focusTrapListener);
                focusTrapListener = null; // Reset bi·∫øn listener
            }
        }

        // --- Form Reset ---
        function resetForm() {
            const taskInput = document.getElementById('taskInput');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');
            if(taskInput) taskInput.value = '';
            if(startTimeInput) startTimeInput.value = '';
            if(endTimeInput) endTimeInput.value = '';
        }

        // --- SortableJS ---
        function initSortable() {
             const taskListBody = document.getElementById('taskList');
             if (!taskListBody) {
                 console.error("Kh√¥ng t√¨m th·∫•y tbody #taskList ƒë·ªÉ kh·ªüi t·∫°o SortableJS.");
                 return;
             }

             // H·ªßy instance c≈© n·∫øu t·ªìn t·∫°i
             if (sortableInstance) {
                 try {
                     sortableInstance.destroy();
                     sortableInstance = null; // Reset instance
                 } catch (e) {
                      console.warn("L·ªói h·ªßy instance Sortable c≈©:", e);
                 }
             }

             // Ch·ªâ kh·ªüi t·∫°o n·∫øu c√≥ c√°c h√†ng c√≥ th·ªÉ k√©o th·∫£
             if (taskListBody.querySelector('.draggable')) {
                 try {
                     sortableInstance = Sortable.create(taskListBody, {
                         animation: 250, // Th·ªùi gian animation
                         handle: '.draggable', // Ch·ªâ k√©o th·∫£ khi gi·ªØ v√†o h√†ng c√≥ class draggable
                         ghostClass: 'sortable-ghost', // Class cho ph·∫ßn t·ª≠ "b√≥ng ma"
                         chosenClass: 'sortable-chosen', // Class cho ph·∫ßn t·ª≠ ƒëang ƒë∆∞·ª£c ch·ªçn
                         dragClass: 'sortable-drag', // Class cho ph·∫ßn t·ª≠ ƒëang ƒë∆∞·ª£c k√©o
                         onEnd: (evt) => { // S·ª± ki·ªán khi k·∫øt th√∫c k√©o th·∫£
                             let tasks = getTasks();
                             // L·∫•y th·ª© t·ª± ID m·ªõi t·ª´ DOM
                             const taskIdsOrder = Array.from(evt.target.children)
                                                    .map(row => parseInt(row.dataset.id))
                                                    .filter(id => !isNaN(id)); // L·ªçc b·ªè ID kh√¥ng h·ª£p l·ªá

                             let orderChanged = false;
                             // C·∫≠p nh·∫≠t thu·ªôc t√≠nh 'order' ch·ªâ cho c√°c c√¥ng vi·ªác trong ng√†y ƒëang ch·ªçn
                             tasks = tasks.map(task => {
                                 if (task.date === selectedDate) {
                                     const newOrder = taskIdsOrder.indexOf(task.id);
                                     // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu t√¨m th·∫•y task v√† th·ª© t·ª± thay ƒë·ªïi
                                     if (newOrder !== -1 && task.order !== newOrder) {
                                         task.order = newOrder;
                                         orderChanged = true;
                                     } else if (newOrder === -1) {
                                         // N·∫øu task kh√¥ng c√≥ trong th·ª© t·ª± m·ªõi (l·ªói?), kh√¥ng thay ƒë·ªïi order
                                         console.warn(`Task ID ${task.id} kh√¥ng t√¨m th·∫•y trong th·ª© t·ª± m·ªõi sau khi k√©o th·∫£.`);
                                     }
                                 }
                                 return task;
                             });

                             if (orderChanged) {
                                 saveTasks(tasks);
                                 // Kh√¥ng c·∫ßn t·∫£i l·∫°i UI v√¨ SortableJS ƒë√£ c·∫≠p nh·∫≠t DOM
                                 // C√≥ th·ªÉ th√™m ph·∫£n h·ªìi tr·ª±c quan n·∫øu mu·ªën
                                 // console.log("Th·ª© t·ª± c√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");
                             }
                         }
                     });
                 } catch (e) {
                      console.error("L·ªói kh·ªüi t·∫°o SortableJS:", e);
                      sortableInstance = null; // ƒê·∫£m b·∫£o instance l√† null n·∫øu c√≥ l·ªói
                 }
             } else {
                  // console.log("Kh√¥ng c√≥ m·ª•c n√†o ƒë·ªÉ k√©o th·∫£, SortableJS kh√¥ng ƒë∆∞·ª£c kh·ªüi t·∫°o.");
                  sortableInstance = null; // ƒê·∫£m b·∫£o instance l√† null n·∫øu kh√¥ng c√≥ m·ª•c k√©o th·∫£
             }
        }

        // --- History Loading ---
        function loadHistory(date) {
            const historyListBody = document.getElementById('historyList');
            if (!historyListBody) {
                console.error("Kh√¥ng t√¨m th·∫•y tbody #historyList.");
                return;
            }
            historyListBody.innerHTML = ''; // X√≥a l·ªãch s·ª≠ c≈©

            if (!date) {
                 historyListBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; font-style: italic;">Ch·ªçn m·ªôt ng√†y ƒë·ªÉ xem l·ªãch s·ª≠.</td></tr>`;
                 return;
            }

            const tasksForDate = getTasks()
                .filter(task => task.date === date)
                // S·∫Øp x·∫øp l·ªãch s·ª≠ theo th·ª© t·ª± ƒë√£ l∆∞u
                .sort((a, b) => (a.order ?? a.id) - (b.order ?? b.id));

            if (tasksForDate.length === 0) {
                 historyListBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; font-style: italic;">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c ghi nh·∫≠n cho ng√†y ${formatDate(date)}.</td></tr>`;
            } else {
                tasksForDate.forEach((task, index) => {
                    // S·ª≠ d·ª•ng renderTask nh∆∞ng v·ªõi ID c·ªßa b·∫£ng l·ªãch s·ª≠
                    renderTask(task, 'historyList');
                    // Animation cho c√°c h√†ng l·ªãch s·ª≠
                    const historyRow = historyListBody.querySelector(`tr[data-id="${task.id}"]`);
                    if (historyRow) {
                        gsap.from(historyRow, {
                            opacity: 0,
                            y: 15,
                            duration: 0.4,
                            ease: "power2.out",
                            delay: index * 0.04 // Delay tƒÉng d·∫ßn
                        });
                    }
                });
            }
        }

        // --- Charting & Insights ---
        function updateCharts() {
            // ƒê·∫£m b·∫£o Chart.js ƒë√£ ƒë∆∞·ª£c t·∫£i
            if (typeof Chart === 'undefined') {
                 console.warn("Chart.js ch∆∞a ƒë∆∞·ª£c t·∫£i. B·ªè qua c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì.");
                 // C√≥ th·ªÉ th·ª≠ l·∫°i ho·∫∑c hi·ªÉn th·ªã th√¥ng b√°o
                 // setTimeout(updateCharts, 500);
                 return;
            }
            showLoading();
            try { // B·ªçc logic bi·ªÉu ƒë·ªì trong try...catch
                const tasks = getTasks();
                // L·∫•y m√†u t·ª´ bi·∫øn CSS, c√≥ fallback
                const textColor = getCssVariable('--text-light') || '#111827';
                const primaryColor = getCssVariable('--primary') || '#3b82f6';
                const secondaryColor = getCssVariable('--secondary') || '#ef4444';
                // const accentColor = getCssVariable('--accent') || '#f59e0b'; // Kh√¥ng d√πng tr·ª±c ti·∫øp trong bi·ªÉu ƒë·ªì n√†y
                const gridColor = document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.1)';
                const glassBgColor = getCssVariable('--glass-bg') || 'rgba(255, 255, 255, 0.2)';

                // --- Chart 1: Daily Task Completion (PIE CHART) ---
                const todayTasks = tasks.filter(task => task.date === selectedDate);
                const completedToday = todayTasks.filter(task => task.status === 'Completed').length;
                const incompleteToday = todayTasks.length - completedToday;

                const dailyChartCtx = document.getElementById('dailyChart')?.getContext('2d');
                if (!dailyChartCtx) {
                     console.error("Kh√¥ng t√¨m th·∫•y context canvas c·ªßa bi·ªÉu ƒë·ªì h√†ng ng√†y.");
                     hideLoading();
                     return;
                }
                // H·ªßy bi·ªÉu ƒë·ªì c≈© tr∆∞·ªõc khi v·∫Ω m·ªõi
                if (dailyChart) dailyChart.destroy();

                dailyChart = new Chart(dailyChartCtx, {
                    type: 'pie', // *** THAY ƒê·ªîI: th√†nh 'pie' ***
                    data: {
                        labels: ['ƒê√£ ho√†n th√†nh', 'Ch∆∞a ho√†n th√†nh'], // ƒê√£ d·ªãch
                        datasets: [{
                            label: 'C√¥ng vi·ªác', // ƒê√£ d·ªãch
                            data: [completedToday, incompleteToday],
                            backgroundColor: [primaryColor, secondaryColor],
                            borderColor: glassBgColor, // M√†u vi·ªÅn nh·∫π nh√†ng
                            borderWidth: 2, // Gi·∫£m ƒë·ªô d√†y vi·ªÅn
                            hoverOffset: 8 // *** TH√äM: Hi·ªáu ·ª©ng khi hover ***
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        // cutout: 0, // *** B·ªé ho·∫∑c ƒë·∫∑t l√† 0 ƒë·ªÉ th√†nh pie chart ***
                        animation: {
                            duration: 1200, // TƒÉng th·ªùi gian animation
                            easing: 'easeOutQuart' // *** THAY ƒê·ªîI: Easing m∆∞·ª£t h∆°n ***
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: textColor, font: { size: 13, family: 'Inter' }, boxWidth: 15, padding: 20 }
                            },
                            title: {
                                display: true,
                                text: `C√¥ng vi·ªác ng√†y ${formatDate(selectedDate)}`, // ƒê√£ d·ªãch
                                color: textColor,
                                font: { size: 16, family: 'Poppins', weight: '500' },
                                padding: { top: 5, bottom: 15 }
                            },
                            tooltip: {
                                bodyFont: { family: 'Inter' },
                                titleFont: { family: 'Poppins' },
                                callbacks: { // Hi·ªÉn th·ªã ph·∫ßn trƒÉm trong tooltip
                                     label: function(context) {
                                         let label = context.label || '';
                                         if (label) label += ': ';
                                         const value = context.parsed || 0;
                                         const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                         const percentage = total > 0 ? ((value / total) * 100).toFixed(0) + '%' : '0%';
                                         label += `${value} (${percentage})`;
                                         return label;
                                     }
                                }
                            }
                        }
                    }
                });

                // --- Chart 2: Weekly Completion Rate (BAR CHART) ---
                const allDates = [...new Set(tasks.map(task => task.date))].sort();
                // L·∫•y t·ªëi ƒëa 7 ng√†y g·∫ßn nh·∫•t *k·∫øt th√∫c v√†o ho·∫∑c tr∆∞·ªõc* ng√†y ƒëang ch·ªçn
                const relevantDates = allDates.filter(d => d <= selectedDate);
                const startIndex = Math.max(0, relevantDates.length - 7);
                const pastDays = relevantDates.slice(startIndex);


                const historyData = pastDays.map(date => {
                    const dayTasks = tasks.filter(task => task.date === date);
                    const completed = dayTasks.filter(task => task.status === 'Completed').length;
                    const total = dayTasks.length;
                    // Tr·∫£ v·ªÅ 0 n·∫øu kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong ng√†y ƒë√≥
                    return total > 0 ? Math.round((completed / total) * 100) : 0;
                });

                const historyChartCtx = document.getElementById('historyChart')?.getContext('2d');
                 if (!historyChartCtx) {
                     console.error("Kh√¥ng t√¨m th·∫•y context canvas c·ªßa bi·ªÉu ƒë·ªì l·ªãch s·ª≠.");
                     hideLoading();
                     return;
                }
                // H·ªßy bi·ªÉu ƒë·ªì c≈©
                if (historyChart) historyChart.destroy();

                historyChart = new Chart(historyChartCtx, {
                    type: 'bar',
                    data: {
                        // S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng ng√†y ng·∫Øn g·ªçn cho nh√£n tr·ª•c X
                        labels: pastDays.map(date => new Date(`${date}T00:00:00Z`).toLocaleDateString('vi-VN', { day: 'numeric', month: 'numeric' })),
                        datasets: [{
                            label: 'T·ª∑ l·ªá ho√†n th√†nh (%)', // ƒê√£ d·ªãch
                            data: historyData,
                            backgroundColor: primaryColor,
                            borderColor: primaryColor,
                            borderWidth: 1,
                            borderRadius: 6, // Bo g√≥c c·ªôt
                            barThickness: 'flex', // ƒê·ªô r·ªông c·ªôt linh ho·∫°t
                            maxBarThickness: 40 // Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1000, easing: 'easeOutCubic' },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: textColor, font: { family: 'Inter' }, stepSize: 20 },
                                grid: { color: gridColor, drawBorder: false } // M√†u l∆∞·ªõi nh·∫°t h∆°n
                            },
                            x: {
                                ticks: { color: textColor, font: { family: 'Inter' } },
                                grid: { display: false } // ·∫®n l∆∞·ªõi tr·ª•c X
                            }
                        },
                        plugins: {
                            legend: { display: false }, // ·∫®n ch√∫ gi·∫£i (ch·ªâ c√≥ 1 dataset)
                            title: {
                                display: true,
                                text: 'T·ª∑ l·ªá ho√†n th√†nh g·∫ßn ƒë√¢y (%)', // ƒê√£ d·ªãch
                                color: textColor,
                                font: { size: 16, family: 'Poppins', weight: '500' },
                                padding: { top: 5, bottom: 15 }
                            },
                            tooltip: {
                                bodyFont: { family: 'Inter' },
                                titleFont: { family: 'Poppins' },
                                callbacks: {
                                    title: function(context) {
                                         // Hi·ªÉn th·ªã ng√†y ƒë·∫ßy ƒë·ªß trong ti√™u ƒë·ªÅ tooltip
                                         const index = context[0]?.dataIndex;
                                         if (index !== undefined && pastDays[index]) {
                                             return formatDate(pastDays[index]); // S·ª≠ d·ª•ng h√†m formatDate
                                         }
                                         return '';
                                    },
                                    label: function(context) {
                                        // Hi·ªÉn th·ªã t·ª∑ l·ªá %
                                        return `${context.dataset.label}: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        }
                    }
                });

                // --- C·∫≠p nh·∫≠t Insights ---
                updateInsights(tasks, todayTasks, pastDays, historyData);

            } catch (e) {
                 console.error("L·ªói c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì:", e);
                 // C√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng
                 // document.getElementById('chartError').textContent = "L·ªói khi t·∫£i bi·ªÉu ƒë·ªì.";
            } finally {
                hideLoading(); // Lu√¥n ·∫©n loading d√π th√†nh c√¥ng hay th·∫•t b·∫°i
            }
        }

        function updateInsights(allTasks, todayTasks, pastWeekDays, pastWeekRates) {
            const dailyCommentList = document.getElementById('dailyComment');
            const weeklyCommentList = document.getElementById('weeklyComment');
            if (!dailyCommentList || !weeklyCommentList) {
                console.error("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ ul cho insights.");
                return;
            }

            dailyCommentList.innerHTML = '';
            weeklyCommentList.innerHTML = '';

            const totalToday = todayTasks.length;
            const completedToday = todayTasks.filter(task => task.status === 'Completed').length;
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p chia cho 0
            const todayCompletionRate = totalToday > 0 ? (completedToday / totalToday) * 100 : 0;

            // --- Daily Insights (Nh·∫≠n x√©t trong ng√†y) ---
            const dailyItems = [];
            dailyItems.push(`<li><strong>C√¥ng vi·ªác h√¥m nay</strong>: ${totalToday} (${completedToday} ho√†n th√†nh)</li>`);
            // Th√™m class n·∫øu ho√†n th√†nh 100%
            dailyItems.push(`<li class="${todayCompletionRate === 100 ? 'insight-completed' : ''}"><strong>Ho√†n th√†nh</strong>: ${todayCompletionRate.toFixed(0)}%</li>`);

            if (totalToday > 0) {
                // T√≠nh th·ªùi gian trung b√¨nh, l·ªçc b·ªè c√°c gi√° tr·ªã kh√¥ng h·ª£p l·ªá
                const durations = todayTasks.map(task => getTaskDuration(task.startTime, task.endTime)).filter(d => !isNaN(d) && d > 0);
                if (durations.length > 0) {
                    const avgDuration = durations.reduce((sum, dur) => sum + dur, 0) / durations.length;
                    dailyItems.push(`<li><strong>Th·ªùi gian TB</strong>: ${avgDuration.toFixed(0)} ph√∫t</li>`);
                } else {
                    dailyItems.push(`<li><strong>Th·ªùi gian TB</strong>: N/A</li>`); // N·∫øu kh√¥ng c√≥ task n√†o c√≥ th·ªùi gian h·ª£p l·ªá
                }
            }

            let dailyAdvice = '';
            if (totalToday === 0) {
                dailyAdvice = "H√£y l√™n k·∫ø ho·∫°ch cho ng√†y h√¥m nay! D√π ch·ªâ m·ªôt vi·ªác nh·ªè c≈©ng t·∫°o ra s·ª± kh√°c bi·ªát.";
            } else if (todayCompletionRate === 100) {
                dailyAdvice = "Tuy·ªát v·ªùi! ƒê√£ ho√†n th√†nh t·∫•t c·∫£ c√¥ng vi·ªác. H√£y chu·∫©n b·ªã cho ng√†y mai!";
            } else if (todayCompletionRate >= 75) {
                dailyAdvice = `L√†m t·ªët l·∫Øm! ${todayCompletionRate.toFixed(0)}% c√¥ng vi·ªác ƒë√£ xong. C·ªë g·∫Øng ho√†n th√†nh n·ªët nh√©!`;
            } else if (todayCompletionRate >= 40) {
                dailyAdvice = `Ti·∫øn ƒë·ªô kh√° t·ªët. T·∫≠p trung v√†o c√¥ng vi·ªác quan tr·ªçng ti·∫øp theo n√†o.`;
            } else {
                dailyAdvice = `C·ªë l√™n n√†o! H√£y ∆∞u ti√™n v√† gi·∫£i quy·∫øt t·ª´ng vi·ªác m·ªôt.`;
            }
            if (dailyAdvice) {
                dailyItems.push(`<li class="advice">${dailyAdvice}</li>`);
            }

            dailyCommentList.innerHTML = dailyItems.join('');
            animateListItems(dailyCommentList); // Animation cho list items


            // --- Weekly Insights (Nh·∫≠n x√©t tu·∫ßn) ---
            const weeklyItems = [];
            if (pastWeekDays.length === 0) {
                weeklyItems.push(`<li>Kh√¥ng c√≥ d·ªØ li·ªáu c√¥ng vi·ªác cho tu·∫ßn qua.</li>`);
                weeklyItems.push(`<li class="advice">H√£y b·∫Øt ƒë·∫ßu ghi l·∫°i c√¥ng vi·ªác h√†ng ng√†y ƒë·ªÉ theo d√µi ti·∫øn ƒë·ªô c·ªßa b·∫°n!</li>`);
            } else {
                // L·ªçc b·ªè c√°c gi√° tr·ªã NaN tr∆∞·ªõc khi t√≠nh to√°n
                const validRates = pastWeekRates.filter(rate => !isNaN(rate));
                const averageCompletion = validRates.length > 0 ? validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length : 0;

                const totalTasksPastWeek = pastWeekDays.reduce((sum, date) => {
                     const tasksOnDate = allTasks.filter(t => t.date === date).length;
                     return sum + tasksOnDate;
                }, 0);
                const avgTasksPerDay = pastWeekDays.length > 0 ? totalTasksPastWeek / pastWeekDays.length : 0;

                // Th√™m class n·∫øu t·ª∑ l·ªá ho√†n th√†nh TB cao
                weeklyItems.push(`<li class="${averageCompletion >= 80 ? 'insight-completed' : ''}"><strong>Ho√†n th√†nh TB (${pastWeekDays.length} ng√†y qua)</strong>: ${averageCompletion.toFixed(0)}%</li>`);
                weeklyItems.push(`<li><strong>C√¥ng vi·ªác TB/Ng√†y</strong>: ${avgTasksPerDay.toFixed(1)}</li>`);

                if (validRates.length > 0) {
                    const maxRate = Math.max(...validRates);
                    const minRate = Math.min(...validRates);
                    // T√¨m index c·ªßa ng√†y t·ªët nh·∫•t/t·ªá nh·∫•t trong m·∫£ng validRates
                    const bestDayIndicesInValid = validRates.map((rate, index) => rate === maxRate ? index : -1).filter(index => index !== -1);
                    const worstDayIndicesInValid = validRates.map((rate, index) => rate === minRate ? index : -1).filter(index => index !== -1);

                    // Map index t·ª´ validRates tr·ªü l·∫°i pastWeekDays
                    // C·∫ßn c·∫©n th·∫≠n n·∫øu validRates v√† pastWeekRates kh√¥ng c√πng ƒë·ªô d√†i (do filter NaN)
                    // C√°ch an to√†n h∆°n: t√¨m index trong pastWeekRates g·ªëc
                    const bestDayIndices = pastWeekRates.map((rate, index) => rate === maxRate ? index : -1).filter(index => index !== -1);
                    const worstDayIndices = pastWeekRates.map((rate, index) => rate === minRate ? index : -1).filter(index => index !== -1);


                    if (bestDayIndices.length > 0 && bestDayIndices[0] < pastWeekDays.length) {
                         const bestDayDate = pastWeekDays[bestDayIndices[0]]; // L·∫•y ng√†y ƒë·∫ßu ti√™n t·ªët nh·∫•t
                         weeklyItems.push(`<li class="insight-completed"><strong>Hi·ªáu su·∫•t cao nh·∫•t</strong>: ${getDayName(bestDayDate)} (${maxRate.toFixed(0)}%)</li>`);
                    }
                    // Ch·ªâ hi·ªÉn th·ªã ng√†y t·ªá nh·∫•t n·∫øu kh√°c ng√†y t·ªët nh·∫•t v√† kh√¥ng ph·∫£i l√† 0% v√†o ng√†y kh√¥ng c√≥ task
                    if (worstDayIndices.length > 0 && worstDayIndices[0] < pastWeekDays.length) {
                         const worstDayDate = pastWeekDays[worstDayIndices[0]]; // L·∫•y ng√†y ƒë·∫ßu ti√™n t·ªá nh·∫•t
                         const tasksOnWorstDay = allTasks.filter(t => t.date === worstDayDate).length;
                         // Ki·ªÉm tra xem ƒë√≥ c√≥ ph·∫£i l√† ng√†y nƒÉng su·∫•t th·∫•p th·ª±c s·ª± kh√¥ng (kh√¥ng ph·∫£i ch·ªâ l√† ng√†y ngh·ªâ)
                         if (!bestDayIndices.includes(worstDayIndices[0]) && (minRate > 0 || tasksOnWorstDay > 0)) {
                              weeklyItems.push(`<li><strong>Hi·ªáu su·∫•t th·∫•p nh·∫•t</strong>: ${getDayName(worstDayDate)} (${minRate.toFixed(0)}%)</li>`);
                         }
                    }
                }


                let weeklyAdvice = '';
                if (averageCompletion >= 80) {
                    weeklyAdvice = "Duy tr√¨ r·∫•t t·ªët! H√£y ti·∫øp t·ª•c ph√°t huy.";
                } else if (averageCompletion >= 50) {
                    weeklyAdvice = "K·∫øt qu·∫£ ·ªïn ƒë·ªãnh. Xem x√©t c√°c ng√†y hi·ªáu su·∫•t th·∫•p ƒë·ªÉ c·∫£i thi·ªán.";
                } else {
                    weeklyAdvice = "T·∫≠p trung x√¢y d·ª±ng th√≥i quen nh·∫•t qu√°n. B·∫Øt ƒë·∫ßu t·ª´ nh·ªØng vi·ªác nh·ªè!";
                }
                 if (weeklyAdvice) {
                    weeklyItems.push(`<li class="advice">${weeklyAdvice}</li>`);
                }
            }

            weeklyCommentList.innerHTML = weeklyItems.join('');
            animateListItems(weeklyCommentList); // Animation cho list items
        }

        function animateListItems(listElement) {
             if (!listElement) return;
             const items = listElement.querySelectorAll('li');
             if (items.length > 0) {
                 // Animation xu·∫•t hi·ªán cho c√°c m·ª•c trong danh s√°ch
                 gsap.from(items, {
                     opacity: 0,
                     y: 15, // Tr∆∞·ª£t nh·∫π t·ª´ d∆∞·ªõi l√™n
                     duration: 0.4,
                     stagger: 0.08, // Xu·∫•t hi·ªán l·∫ßn l∆∞·ª£t
                     ease: "power2.out"
                 });
             }
        }

        // --- Initial Load & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setTheme(); // ƒê·∫∑t theme s√°ng/t·ªëi d·ª±a tr√™n h·ªá th·ªëng
                // Tr√¨ ho√£n kh·ªüi t·∫°o particles m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o container t·ªìn t·∫°i
                setTimeout(initParticles, 100);
                initFlatpickr(); // T·ª± x·ª≠ l√Ω vi·ªác th·ª≠ l·∫°i n·∫øu c·∫ßn
                setDayColors(); // ƒê·∫∑t m√†u s·∫Øc d·ª±a tr√™n ng√†y hi·ªán t·∫°i
                loadTasks(); // T·∫£i c√¥ng vi·ªác cho ng√†y hi·ªán t·∫°i
                updateCharts(); // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì (t·ª± ki·ªÉm tra Chart.js)
                registerServiceWorker(); // ƒêƒÉng k√Ω PWA

                // L·∫Øng nghe thay ƒë·ªïi theme h·ªá th·ªëng
                window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", setTheme);

                // T√πy ch·ªçn: T·∫£i l·ªãch s·ª≠ cho ng√†y c√≥ c√¥ng vi·ªác g·∫ßn nh·∫•t khi m·ªü ·ª©ng d·ª•ng
                // const lastTaskDate = getTaskDates().pop();
                // if (lastTaskDate && historyDateInstance) {
                //      historyDateInstance.setDate(lastTaskDate, false); // ƒê·∫∑t ng√†y m√† kh√¥ng k√≠ch ho·∫°t onChange
                //      loadHistory(lastTaskDate);
                // }

                // --- Initial GSAP Animations ---
                // Animation cho c√°c th√†nh ph·∫ßn ch√≠nh khi t·∫£i trang
                gsap.from(".container > h1", { opacity: 0, y: -40, duration: 0.8, delay: 0.2, ease: "power3.out" });
                gsap.from(".date-picker", { opacity: 0, y: -30, duration: 0.7, delay: 0.4, ease: "power3.out" });
                gsap.from(".task-form", { opacity: 0, scale: 0.95, y: 30, duration: 0.7, delay: 0.6, ease: "back.out(1.2)" });
                // Delay animation cho b·∫£ng, bi·ªÉu ƒë·ªì, insights, history nhi·ªÅu h∆°n m·ªôt ch√∫t
                gsap.from(".table-responsive, .charts, .insights, .history", {
                    opacity: 0,
                    y: 40,
                    duration: 0.8,
                    stagger: 0.15, // Xu·∫•t hi·ªán l·∫ßn l∆∞·ª£t
                    delay: 1.0, // TƒÉng delay
                    ease: "power3.out"
                });

            } catch (e) {
                 console.error("L·ªói trong qu√° tr√¨nh kh·ªüi t·∫°o DOMContentLoaded:", e);
                 alert("ƒê√£ x·∫£y ra l·ªói khi t·∫£i ·ª©ng d·ª•ng. Vui l√≤ng th·ª≠ l√†m m·ªõi trang.");
            }
        });

    </script>
</body>
</html>